---
title: "Model Selection and Variance Components"
output: html_notebook
params:
  isonline:
    label: 'Online (y/n)'
    value: FALSE
    choices: [TRUE, FALSE]
---

# Disclaimer
Data and code for the demo on model selection and variance components are shown in this notebook.


# Data
The data is available from the following path

```{r, echo=FALSE}
s_ms_vc_path <- "https://charlotte-ngs.github.io/pigsciencess2022/data/bw_bc_rand_pred.csv"
if (!params$isonline)
  s_ms_vc_path <- file.path(here::here(), "docs", "data", "bw_bc_rand_pred.csv")
cat(s_ms_vc_path)
```

Data is read from file by

```{r}
tbl_ms_vc <- readr::read_csv(file = s_ms_vc_path)
tbl_ms_vc
```


# Descriptive Statistics
Pairs plot gives an overview

```{r}
pairs(tbl_ms_vc)
```

Ignore first column with animal IDs

```{r}
pairs(tbl_ms_vc[,c("Breast Circumference", "Body Weight", "RandPred")])
```

Alternative selection with `dplyr::select()`
```{r}
library(dplyr)
pairs(tbl_ms_vc %>% select(-Animal))
```


# Model Selection
Do predictors in the model explain any variability of response at all

```{r}
aov_bw_bc_rp <- aov(formula = `Body Weight` ~ `Breast Circumference` + RandPred, 
                    data = tbl_ms_vc)
summary(aov_bw_bc_rp)
```

Most of the variability of the response is explained by `Breast Circumference`. `RandPred` does not explain a lot.

The regression tell something about how much the response changes when the predictor changes one unit

```{r}
lm_bw_bc_rp <- lm(formula = `Body Weight` ~ `Breast Circumference` + RandPred, 
                    data = tbl_ms_vc)
summary(lm_bw_bc_rp)

```

Select the best model

```{r}
tbl_ms_vc_olsrr <- tbl_ms_vc %>% rename(BW = `Body Weight`, BC = `Breast Circumference`)
lm_ms_vc_olsrr <- lm(BW ~ BC + RandPred, data = tbl_ms_vc_olsrr)
olsrr::ols_step_best_subset(lm_ms_vc_olsrr)
```

```{r}
MASS::stepAIC(lm_ms_vc_olsrr)
```


# Variance Components
Adding sires to the data

```{r}
tbl_ms_vc_sire <- tbl_ms_vc
tbl_ms_vc_sire$Sire <- c(rep(1,3), rep(2,3), rep(3,4))
tbl_ms_vc_sire
```

Convert sire column to factor

```{r}
tbl_ms_vc_sire$Sire <- as.factor(tbl_ms_vc_sire$Sire)
tbl_ms_vc_sire
```

Simplify computations with a balanced dataset

```{r}
tbl_ms_vc_sire <- tbl_ms_vc_sire[1:9,]
```

ANOVA

```{r}
aov_ms_vc_sire <- aov(`Body Weight` ~ Sire, data = tbl_ms_vc_sire)
smry_aov_ms_vc_sire <- summary(aov_ms_vc_sire)
smry_aov_ms_vc_sire
```

What is the variance of the sire effect? Use the fact that 

$$E(MSQ_R) = \sigma_e^2$$
Hence $\widehat{\sigma_e^2} = MSQ_R = `r smry_aov_ms_vc_sire[[1]]["Residuals", "Mean Sq"]`$. 

Furthermore 

$$E(MSQ_S) = n_S * \sigma_S^2 + \sigma_e^2 $$

Hence 

$$\widehat{\sigma_S^2} = \frac{MSQ_S - MSQ_R}{n_S} = 
\frac{`r smry_aov_ms_vc_sire[[1]]["Sire", "Mean Sq"]` - `r smry_aov_ms_vc_sire[[1]]["Residuals", "Mean Sq"]`}{3}$$


```{r}
n_sigma_s2 <- (smry_aov_ms_vc_sire[[1]]["Sire", "Mean Sq"] - smry_aov_ms_vc_sire[[1]]["Residuals", "Mean Sq"]) / 3
n_sigma_s2
```


lme4

```{r}
lmer_ms_vc_sire <- lme4::lmer(`Body Weight` ~ (1|Sire), data = tbl_ms_vc_sire)
summary(lmer_ms_vc_sire)
```

